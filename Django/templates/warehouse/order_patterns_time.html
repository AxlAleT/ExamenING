{% extends "base.html" %}

{% block title %}Order Patterns by Time | FoodHub Dashboard{% endblock %}

{% block page_title %}Order Patterns by Time{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h5>Order Patterns by Time Slot and Day</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Day of Week</th>
                        <th>Time Slot</th>
                        <th>Total Orders</th>
                        <th>Total Revenue</th>
                        <th>Avg Total Time (min)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pattern in time_patterns %}
                    <tr>
                        <td>{{ pattern.date__day_of_week }}</td>
                        <td>{{ pattern.time_slot__slot_name }}</td>
                        <td>{{ pattern.total_orders }}</td>
                        <td>${{ pattern.total_revenue|floatformat:2 }}</td>
                        <td>{{ pattern.avg_total_time|floatformat:1 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No time pattern data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Order Volume by Day of Week and Time Slot</h5>
            </div>
            <div class="card-body">
                <canvas id="heatmapChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Process data for heatmap
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const timeSlots = [];
    const dataMap = {};

    // Extract unique time slots and prepare data structure
    {% for pattern in time_patterns %}
        if (!timeSlots.includes("{{ pattern.time_slot__slot_name }}")) {
            timeSlots.push("{{ pattern.time_slot__slot_name }}");
        }

        const key = "{{ pattern.date__day_of_week }}_{{ pattern.time_slot__slot_name }}";
        dataMap[key] = {{ pattern.total_orders }};
    {% endfor %}

    // Sort time slots if possible (assuming they follow a pattern like "Morning", "Afternoon", etc.)
    timeSlots.sort();

    // Create datasets for Chart.js
    const datasets = [];
    days.forEach((day, index) => {
        const data = [];
        timeSlots.forEach(slot => {
            const key = day + "_" + slot;
            data.push(dataMap[key] || 0);
        });

        datasets.push({
            label: day,
            data: data,
            backgroundColor: `rgba(${50 + index * 30}, ${100 + index * 20}, ${150 + index * 15}, 0.7)`,
            borderColor: `rgba(${50 + index * 30}, ${100 + index * 20}, ${150 + index * 15}, 1)`,
            borderWidth: 1
        });
    });

    // Render chart
    const ctx = document.getElementById('heatmapChart').getContext('2d');
    const heatmapChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: timeSlots,
            datasets: datasets
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endblock %}
